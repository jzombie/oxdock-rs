name: rust-tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

# Ensure only one run per branch/PR at a time. If new commits are pushed,
# older jobs will be automatically canceled.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test_matrix:
    name: test (OS=${{ matrix.os }}, Features=${{ matrix.name }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - name: "All Features"
            flags: "--all-features"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

  #    - name: Free disk space on Linux runner
  #      if: runner.os == 'Linux'
  #      run: |
  #        sudo rm -rf /usr/share/dotnet
  #        sudo rm -rf /usr/local/lib/android
  #        sudo rm -rf /opt/ghc

      - name: Capture rustc commit hash
        id: rustc
        shell: bash
        run: |
          set -euo pipefail
          rustc -Vv
          echo "hash=$(rustc -Vv | sed -n 's/^commit-hash: //p')" >> "$GITHUB_OUTPUT"

      # Workaround for macOS error when using `hashFiles`:
      # "Error: The template is not valid....Fail to hash files under directory"
      - name: Calculate lockfile hash
        id: lockfile
        shell: bash
        run: |
          if command -v sha256sum >/dev/null 2>&1; then
            HASH=$(sha256sum Cargo.lock | awk '{print $1}')
          elif command -v shasum >/dev/null 2>&1; then
            HASH=$(shasum -a 256 Cargo.lock | awk '{print $1}')
          else
            echo "No hashing utility found"
            exit 1
          fi
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"

      # Added caching step to speed up dependency builds.
      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ steps.rustc.outputs.hash }}-${{ steps.lockfile.outputs.hash }}-${{ matrix.flags }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ steps.rustc.outputs.hash }}-${{ steps.lockfile.outputs.hash }}-

      - name: Test
        run: cargo test --workspace --all-features --lib --bins --tests --examples -- --include-ignored

  test:
    name: test
    runs-on: ubuntu-latest
    needs: test_matrix
    if: ${{ always() }}
    steps:
      - name: Evaluate matrix results
        run: |
          result="${{ needs.test_matrix.result }}"
          echo "Matrix job concluded with: ${result}"
          if [ "${result}" != "success" ]; then
            exit 1
          fi
          echo "All platform combinations succeeded."

  miri:
    name: miri (ubuntu-latest)
    runs-on: ubuntu-latest
    needs: test_matrix
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install nightly toolchain with Miri
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: miri

      # - name: Free disk space on Linux runner
      #   run: |
      #     sudo rm -rf /usr/share/dotnet
      #     sudo rm -rf /usr/local/lib/android
      #     sudo rm -rf /opt/ghc

      - name: Capture rustc commit hash
        id: rustc-miri
        shell: bash
        run: |
          set -euo pipefail
          rustc -Vv
          echo "hash=$(rustc -Vv | sed -n 's/^commit-hash: //p')" >> "$GITHUB_OUTPUT"

      - name: Calculate lockfile hash
        id: lockfile-miri
        shell: bash
        run: |
          if command -v sha256sum >/dev/null 2>&1; then
            HASH=$(sha256sum Cargo.lock | awk '{print $1}')
          elif command -v shasum >/dev/null 2>&1; then
            HASH=$(shasum -a 256 Cargo.lock | awk '{print $1}')
          else
            echo "No hashing utility found"
            exit 1
          fi
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"

      - name: Cache Cargo dependencies for Miri
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: miri-${{ runner.os }}-${{ steps.rustc-miri.outputs.hash }}-${{ steps.lockfile-miri.outputs.hash }}

      - name: Prepare Miri
        run: cargo miri setup

      - name: Run Miri (unit tests only)
        run: cargo miri test --workspace --all-features --lib --tests

      - name: Report Miri coverage
        shell: bash
        run: |
          set -euo pipefail
          list_cmd="cargo miri test --workspace --all-features --lib --tests"
          total=$($list_cmd -- --list --format terse | grep -c ': test' || true)
          ignored=$($list_cmd -- --ignored --list --format terse | grep -c ': test' || true)
          run_cnt=$((total - ignored))
          if [ "$total" -eq 0 ]; then
            ratio="n/a"
          else
            ratio=$(awk -v r="$run_cnt" -v t="$total" 'BEGIN { printf "%.1f%%", (r / t) * 100 }')
          fi
          echo "Miri runnable tests: ${run_cnt}/${total} (${ratio})"
